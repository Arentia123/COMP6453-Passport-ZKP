import { CircuitSignals } from "circomkit";
import { SignalValueType } from "circomkit/dist/types";
import { poseidon9 } from "poseidon-lite";
import { generateBinaryMerkleRoot } from "../../scripts/utils/imtProofGen";

type INPUT_SIGNALS = [
    "tbs_cert", "tbs_cert_size", "pubkey", "sig", "expected_root", "depth", 
    "indices", "siblings", "cert_pubkey_offset"
];

const MAX_DEPTH = 16;
// equivalent to PackChunks circuit
const packChunks = (chunks: string[]) => {
	const numPacked = Math.ceil(chunks.length / 2);
	const packed: string[] = new Array(numPacked);
	for (let i = 0; i < Math.floor(chunks.length / 2); i++)
		packed[i] = (BigInt(chunks[i * 2]) | (BigInt(chunks[i * 2 + 1]) << 121n)).toString();	

	if ((chunks.length & 1) == 1)
		packed[numPacked - 1] = chunks[chunks.length - 1].toString();

	return packed;
}

const addPoM = (mockData: CircuitSignals<INPUT_SIGNALS>) => {
	// construct IMT with pubkey included
	const pubkeyHash = poseidon9(packChunks(mockData.pubkey as string[])).toString();
	const imtData = generateBinaryMerkleRoot(MAX_DEPTH, ["1", "2", "3", pubkeyHash], 3);
	mockData.expected_root = imtData.root.toString() as SignalValueType;
	mockData.depth = imtData.depth.toString() as SignalValueType;
	mockData.indices = imtData.indices.map((index) => index.toString() as SignalValueType);
	mockData.siblings = imtData.siblings.map((sibling) => sibling.toString() as SignalValueType);
}

const mockCertData: CircuitSignals<INPUT_SIGNALS> = {
	"tbs_cert": ["48", "130", "2", "130", "160", "3", "2", "1", "2", "2", "20", "100", "182", "212", "33", "224", "133", "218", "63", "88", "184", "205", "131", "31", "195", "124", "212", "216", "53", "139", "245", "48", "13", "6", "9", "42", "134", "72", "134", "247", "13", "1", "1", "11", "5", "0", "48", "101", "49", "11", "48", "9", "6", "3", "85", "4", "6", "19", "2", "65", "85", "49", "12", "48", "10", "6", "3", "85", "4", "10", "12", "3", "71", "79", "86", "49", "13", "48", "11", "6", "3", "85", "4", "11", "12", "4", "68", "70", "65", "84", "49", "12", "48", "10", "6", "3", "85", "4", "11", "12", "3", "65", "80", "79", "49", "43", "48", "41", "6", "3", "85", "4", "3", "12", "34", "80", "97", "115", "115", "112", "111", "114", "116", "32", "67", "111", "117", "110", "116", "114", "121", "32", "83", "105", "103", "110", "105", "110", "103", "32", "65", "117", "116", "104", "111", "114", "105", "116", "121", "48", "30", "23", "13", "50", "52", "48", "55", "50", "56", "48", "57", "51", "54", "50", "57", "90", "23", "13", "50", "52", "49", "48", "50", "54", "48", "57", "51", "54", "50", "57", "90", "48", "101", "49", "11", "48", "9", "6", "3", "85", "4", "6", "19", "2", "65", "85", "49", "12", "48", "10", "6", "3", "85", "4", "10", "12", "3", "71", "79", "86", "49", "13", "48", "11", "6", "3", "85", "4", "11", "12", "4", "68", "70", "65", "84", "49", "12", "48", "10", "6", "3", "85", "4", "11", "12", "3", "80", "84", "66", "49", "43", "48", "41", "6", "3", "85", "4", "3", "12", "34", "80", "97", "115", "115", "112", "111", "114", "116", "32", "67", "111", "117", "110", "116", "114", "121", "32", "83", "105", "103", "110", "105", "110", "103", "32", "65", "117", "116", "104", "111", "114", "105", "116", "121", "48", "130", "1", "34", "48", "13", "6", "9", "42", "134", "72", "134", "247", "13", "1", "1", "1", "5", "0", "3", "130", "1", "15", "0", "48", "130", "1", "10", "2", "130", "1", "1", "0", "165", "118", "61", "210", "43", "58", "121", "204", "204", "54", "151", "234", "139", "60", "130", "232", "110", "131", "164", "54", "248", "73", "118", "148", "31", "52", "100", "156", "211", "214", "152", "99", "206", "160", "28", "231", "140", "157", "64", "218", "73", "146", "115", "214", "168", "228", "59", "200", "104", "15", "16", "112", "202", "17", "25", "69", "219", "208", "83", "198", "105", "214", "8", "148", "168", "242", "47", "153", "123", "210", "255", "79", "7", "140", "211", "63", "28", "157", "148", "181", "119", "232", "141", "4", "37", "129", "22", "237", "9", "251", "81", "121", "35", "57", "228", "20", "48", "178", "124", "135", "125", "53", "148", "35", "181", "9", "209", "75", "30", "250", "102", "46", "214", "130", "160", "54", "43", "234", "117", "32", "190", "146", "246", "100", "142", "136", "8", "135", "66", "95", "206", "161", "1", "3", "70", "211", "82", "193", "188", "79", "18", "230", "211", "49", "91", "48", "58", "56", "166", "118", "242", "216", "243", "38", "75", "86", "117", "225", "135", "164", "139", "68", "29", "124", "136", "24", "226", "212", "2", "227", "217", "100", "152", "157", "21", "44", "4", "27", "205", "217", "251", "134", "102", "11", "188", "17", "143", "220", "0", "238", "16", "246", "231", "89", "33", "251", "227", "145", "16", "188", "187", "185", "111", "39", "237", "178", "82", "190", "219", "151", "182", "36", "213", "2", "87", "195", "39", "91", "246", "23", "68", "55", "63", "111", "6", "2", "199", "186", "175", "93", "65", "36", "194", "212", "72", "51", "49", "140", "106", "229", "227", "218", "15", "133", "106", "200", "86", "253", "120", "173", "74", "31", "63", "42", "69", "25", "2", "3", "1", "0", "1", "163", "66", "48", "64", "48", "29", "6", "3", "85", "29", "14", "4", "22", "4", "20", "97", "138", "243", "29", "78", "14", "64", "69", "210", "32", "105", "89", "123", "215", "97", "113", "8", "122", "77", "45", "48", "31", "6", "3", "85", "29", "35", "4", "24", "48", "22", "128", "20", "171", "246", "255", "88", "124", "212", "129", "207", "70", "160", "199", "84", "193", "129", "202", "97", "47", "186", "16", "33", "128", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "20", "48", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"],
	"tbs_cert_size": "704",
	"pubkey": ["680944516601832577979354802343254779", "1330927681585282139991367005461296706", "485434736929591414464796895811420798", "2311385811812566487788338442529315073", "1682721758040580887734645577983843343", "1413879554570907275483305741945107003", "265048762966799730883041264452122135", "714612886549961231241891024979804530", "2033299892757186890131952403351453892", "2554481936656059855123859417922677183", "1621357438727963500118502604642471998", "519711450211301906972192260544172555", "1127752521918245851476238700991828899", "2603625280010670870514950459232710352", "1435002441281203000843242159112067096", "1387178989252014402394562272909830920", "3813695391996165082831289218863234"],
	"sig": ["1137959652649052017521143597983560029", "1898773404670345869114997880086628403", "425004985883234124665997467371766985", "1401756919265659146916953074040176316", "2382237731796166562224011722377547350", "536105270214575471565001412690551921", "1881097427953318076688715280911572536", "2282179851926747230372037189528140066", "1110885173971422992371110833332105614", "1834316070153267486831158796371521149", "95461806737781890743956754592665259", "701395787961412782846580429312664719", "1621511599977279500834955845108562651", "1418037354710958551796330665991132345", "1083083893730383272488554062052170140", "1881625128303020277954519562728120045", "1735609144669435945014095524369904"],
    "expected_root": "0",
    "depth": "0",
    "indices": ["0"],
    "siblings": ["0"],
	"cert_pubkey_offset": "317"
};

const dsCertPubkey = ["2461463517482784472361682921524446489", "1847754744196920670830712132956680945", "2041652750119943531085012383718687104", "1975387701996842107125632203178603254", "2286687087545635533751306948311355935", "1033725971521095636267872079872683727", "2385288426569432737672065322317115936", "2194506288104979132680312128959237357", "989517156172539750011603574415491910", "690101821409172692718544247021976208", "1102679248840043625079746420690716909", "539422385219502752988550961865531711", "532806266271509899500236814463039693", "1698568001723323327001668211993117342", "1798513454517263176218546690098581338", "1359425732953022114427290554208958887", "3355965640443370479442632133741372"];
const expectedLeaf = poseidon9(packChunks(dsCertPubkey))

addPoM(mockCertData);

export { MAX_DEPTH, mockCertData, expectedLeaf };